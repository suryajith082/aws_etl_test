pipeline {
    agent any

    stages {
        stage('Check or Create Bucket') {
            steps {
                script {
                    def bucketName = "dtcc-pov"
                    def region = "us-east-1"  // change if needed
                    def stackName = "dtcc-pov-stack"
                    def templateFile = "template.yml"

                    // Check if bucket exists
                    def checkBucket = sh(
                        script: "aws s3api head-bucket --bucket ${bucketName} 2>&1 || true",
                        returnStdout: true
                    ).trim()

                    if (checkBucket.contains("Not Found") || checkBucket.contains("404")) {
                        echo "Bucket does not exist. Deploying CloudFormation stack..."
                        sh """
                        aws cloudformation deploy \
                            --stack-name ${stackName} \
                            --template-file ${templateFile} \
                            --capabilities CAPABILITY_NAMED_IAM \
                            --region ${region}
                        """
                    } else {
                        echo "Bucket ${bucketName} already exists. Skipping creation."
                    }
                }
            }
        }
    }
}
