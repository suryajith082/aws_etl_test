pipeline {
    agent any

    stages {
        stage('Check or Create Bucket') {
            steps {
                script {
                    def bucketName = "dtcc_pov"
                    def region = "us-east-1"   // change if needed
                    def stackName = "dtcc-pov-stack"
                    def templateFile = "cloudformation\\s3-bucket.yml"

                    // Check if bucket exists (Windows uses bat instead of sh)
                    def checkBucket = bat(
                        script: "aws s3api head-bucket --bucket ${bucketName} 2>nul || echo NotFound",
                        returnStdout: true
                    ).trim()

                    if (checkBucket.contains("NotFound")) {
                        echo "Bucket does not exist. Deploying CloudFormation stack..."
                        bat """
                        aws cloudformation deploy ^
                            --stack-name ${stackName} ^
                            --template-file ${templateFile} ^
                            --capabilities CAPABILITY_NAMED_IAM ^
                            --region ${region}
                        """
                    } else {
                        echo "Bucket ${bucketName} already exists. Skipping creation."
                    }
                }
            }
        }
    }
}
